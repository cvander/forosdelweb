<?php/*======================================================================*\|| #################################################################### |||| # Custom Forum Home - Foros del Web                                # |||| # @author      David Barrios <davidbarriosfdw@gmail.com            # |||| #################################################################### ||\*======================================================================*/function build_fdwsettings($settings){	if ($settings['newusers'])	{		build_fdwnewusers();	}	if ($settings['birthdays'])	{		build_fdwbirthdays();	}	if ($settings['forumstats'])	{		build_fdwforum_stats(0, $newvalue, null, -1);	}	if ($settings['forumcache'])	{		build_fdwforum_cache();	}	if ($settings['userstats'])	{		$GLOBALS['vbulletin']->db->query_write("TRUNCATE TABLE " . TABLE_PREFIX . "fdwuser");	}	if ($settings['usercache'])	{		$GLOBALS['vbulletin']->db->query_write("TRUNCATE TABLE " . TABLE_PREFIX . "fdwsession");	}}function build_fdwnewusers(){	global $vbulletin;		$condition = '';	if ($vbulletin->options['avatarenabled'] AND $vbulletin->options['fdw_forumhome_newavatars'])	{		$condition = "WHERE (avatar.avatarpath != '' OR NOT ISNULL(customavatar.userid)) AND (" . fetch_avatar_usergroup_condition() . ")";	}		$users_query = $vbulletin->db->query_read("		SELECT user.userid, user.username, 1 AS adminavatar		" . ($vbulletin->options['avatarenabled'] ? ', user.avatarrevision, avatar.avatarpath, NOT ISNULL(customavatar.userid) AS hascustomavatar, customavatar.dateline AS avatardateline, customavatar.width_thumb AS avwidth_thumb, customavatar.height_thumb AS avheight_thumb, customavatar.width as avwidth, customavatar.height as avheight, customavatar.filedata_thumb' : '') . "		FROM " . TABLE_PREFIX . "user AS user		" . ($vbulletin->options['avatarenabled'] ? "LEFT JOIN " . TABLE_PREFIX . "avatar AS avatar ON (avatar.avatarid = user.avatarid) LEFT JOIN " . TABLE_PREFIX . "customavatar AS customavatar ON (customavatar.userid = user.userid) " : '') . "		$condition		ORDER BY user.userid DESC		LIMIT 0, {$vbulletin->options['fdw_forumhome_newusers']}	");		require_once(DIR . '/includes/functions_user.php');	$newusers = array();	while($userinfo = $vbulletin->db->fetch_array($users_query))	{		fetch_avatar_from_userinfo($userinfo, true);		$newusers[] = array(			'userid' => $userinfo['userid'],			'username' => $userinfo['username'],			'avatarurl' => $userinfo['avatarurl']		);	}		build_datastore('fdwnewusers', serialize($newusers), 1);		return $newusers;}function fetch_avatar_usergroup_condition(){	global $vbulletin;		if (isset($vbulletin->fdwavatarcondition))	{		return $vbulletin->fdwavatarcondition;	}		$groups = array(		'canavatar' => array(),		'canshare' => array(),		'canavatarcond' => array()	);		foreach ($vbulletin->usergroupcache AS $usergroup)	{		if ($usergroup['genericpermissions'] & $vbulletin->bf_ugp_genericpermissions['canuseavatar'])		{			$groups['canavatar'][] = $usergroup['usergroupid'];			$groups['canavatarcond'][] = "FIND_IN_SET(" . $usergroup['usergroupid'] . ", user.membergroupids)";		}		if ($usergroup['genericoptions'] & $vbulletin->bf_ugp_genericoptions['allowmembergroups'])		{			$groups['canshare'][] = $usergroup['usergroupid'];		}	}		if (count($groups['canavatar']) > 0)	{		$condition = "user.usergroupid IN (" . implode(',', $groups['canavatar']) . ")			OR (user.usergroupid IN (" . implode(',', $groups['canshare']) . ") AND (" . implode(' OR ', $groups['canavatarcond']) . "))";	} else {		$condition = "FALSE";	}		$vbulletin->fdwavatarcondition = $condition;	return $condition;}function build_fdwbirthdays(){	global $vbulletin;		$userids = array();	foreach (array_merge($vbulletin->birthdaycache['users1'], $vbulletin->birthdaycache['users2']) AS $user)	{		$userids[] = $user['userid'];	}		$birthdayinfo = array();	if (count($userids))	{		$users_query = $vbulletin->db->query_read("			SELECT user.userid, user.usergroupid, user.membergroupids, userfield.field2, user.posts			" . ($vbulletin->options['avatarenabled'] ? ', user.avatarrevision, avatar.avatarpath, NOT ISNULL(customavatar.userid) AS hascustomavatar, customavatar.dateline AS avatardateline, customavatar.width_thumb AS avwidth_thumb, customavatar.height_thumb AS avheight_thumb, customavatar.width as avwidth, customavatar.height as avheight, customavatar.filedata_thumb' : '') . "			FROM " . TABLE_PREFIX . "user AS user			LEFT JOIN " . TABLE_PREFIX . "userfield AS userfield USING (userid)			" . ($vbulletin->options['avatarenabled'] ? "LEFT JOIN " . TABLE_PREFIX . "avatar AS avatar ON (avatar.avatarid = user.avatarid) LEFT JOIN " . TABLE_PREFIX . "customavatar AS customavatar ON (customavatar.userid = user.userid) " : '') . "			WHERE user.userid IN (" . implode(',', $userids) . ")		");				require_once(DIR . '/includes/functions_user.php');		while ($userinfo = $vbulletin->db->fetch_array($users_query))		{			fetch_avatar_from_userinfo($userinfo, true, false);			$birthdayinfo["$userinfo[userid]"] = array(				'avatarurl' => $userinfo['avatarurl'],				'location' => $userinfo['field2'],				'posts' => $userinfo['posts']			);		}	}		build_datastore('fdwbirthdays', serialize($birthdayinfo), 1);	return $birthdayinfo;}function build_fdwforum_stats($userid, $absdays = null, $lastdays = null, $ignoreparent = null){	global $vbulletin;		$vbulletin->db->query_write("UPDATE " . TABLE_PREFIX . "fdwforum SET relevance = 0 WHERE userid = $userid");	if ($userid > 0)	{		$vbulletin->db->query_write("			INSERT IGNORE INTO " . TABLE_PREFIX . "fdwforum (userid, forumid, fdwcolorid, small, relevance, displayorder)				SELECT $userid, forumid, fdwcolorid, small, 0, 0 FROM " . TABLE_PREFIX . "fdwforum WHERE userid = 0		");	}	else	{		$vbulletin->db->query_write("			INSERT IGNORE INTO " . TABLE_PREFIX . "fdwforum (userid, forumid, fdwcolorid, small, relevance, displayorder)				SELECT 0, forumid, 1, 0, 0, 0 FROM " . TABLE_PREFIX . "forum WHERE parentid = -1		");	}		$temptable = "fdwforum_$userid";	$vbulletin->db->query_write("		CREATE TABLE IF NOT EXISTS " . TABLE_PREFIX . "$temptable (			forumid INT UNSIGNED NOT NULL,			views INT UNSIGNED NOT NULL,			threadviews INT UNSIGNED NOT NULL,			PRIMARY KEY (forumid)		) ENGINE = MEMORY	");		$condition = ($userid > 0) ? " AND userid = $userid" : "";	$condition .= ($absdays) ? " AND stattime BETWEEN DATE_SUB(CURDATE(), INTERVAL $absdays DAY) AND CURDATE()" : "";	if ($userid > 0 AND $lastdays)	{		$datelist = array();		$datequery = $vbulletin->db->query_read("SELECT DISTINCT stattime FROM " . TABLE_PREFIX . "fdwuserstats WHERE userid = $userid ORDER BY stattime DESC LIMIT 0, $lastdays");		while ($daterow = $vbulletin->db->fetch_array($datequery))		{			$datelist[] = "'$daterow[stattime]'";		}		if (count($datelist) > 0)		{			$condition .= " AND stattime IN (" . implode(',', $datelist) . ")";		}	}		if ($ignoreparent)	{		$sql_join = "LEFT JOIN " . TABLE_PREFIX . "forum AS forum USING (forumid)";		$condition .= " AND forum.parentid != $ignoreparent";	}	$vbulletin->db->query_write("		INSERT INTO " . TABLE_PREFIX . "$temptable (forumid, views, threadviews)			SELECT forumid, SUM(views), SUM(threadviews) FROM " . TABLE_PREFIX . "fdwuserstats			$sql_join			WHERE 1 = 1			$condition			GROUP BY forumid	");		$vbulletin->db->query_write("		INSERT INTO " . TABLE_PREFIX . "fdwforum (userid, forumid, fdwcolorid, small, relevance, displayorder)			SELECT $userid, forumid, 1, 0, views + IFNULL(threadviews, 0), 0 FROM " . TABLE_PREFIX . "$temptable		ON DUPLICATE KEY UPDATE			relevance = views + IFNULL(threadviews, 0)	");		$vbulletin->db->query_write("DROP TABLE IF EXISTS " . TABLE_PREFIX . "$temptable");		if ($userid > 0)	{		$vbulletin->db->query_write("			REPLACE INTO " . TABLE_PREFIX . "fdwuser (userid, forumcache) VALUES ($userid, " . TIMENOW . ")		");	}}function build_fdwforum_cache(){	global $vbulletin;		$result = $vbulletin->db->query_read("		SELECT fdwforum.forumid, fdwcolorid, small, shorttitle, relevance, forum.parentid FROM " . TABLE_PREFIX . "fdwforum AS fdwforum		LEFT JOIN " . TABLE_PREFIX . "forum AS forum USING (forumid)		WHERE userid = 0		ORDER BY relevance DESC, forum.displayorder	");		$forumorder = array();	$forumcache = array();	while ($forum = $vbulletin->db->fetch_array($result))	{		$forumcache["$forum[forumid]"] = array('fdwforum' => $forum);		$forumorder["$forum[parentid]"]["$forum[forumid]"] = $forum['forumid'];	}		$levelmax = explode(',', $vbulletin->options['fdw_forumhome_levelmax']);	foreach ($forumorder AS $forums)	{		$relevance = array();		foreach ($forums AS $forumid)		{			$relevance["$forumid"] = $forumcache["$forumid"]['fdwforum']['relevance'];		}		if (count($levelmax) > 0)		{			$levels = fdw_fetch_levels($relevance, $levelmax);		}		else		{			$levels = fetch_standard_deviated_levels($relevance, $vbulletin->options['fdw_forumhome_levels']);		}		foreach ($forums AS $forumid)		{			$forumcache["$forumid"]['fdwforum']['level'] = $levels["$forumid"];		}	}		build_datastore('fdwforum', serialize($forumcache), 1);}function build_fdwcolor_cache(){	global $vbulletin;		$fdwcolors = array();		$result = $vbulletin->db->query_read("SELECT * FROM " . TABLE_PREFIX . "fdwcolor");	while ($fdwcolor = $vbulletin->db->fetch_array($result))	{		$fdwcolors["$fdwcolor[fdwcolorid]"] = $fdwcolor;	}		build_datastore('fdwcolor', serialize($fdwcolors), 1);}function build_fdwforum_usercache($sessionhash, $userid){	global $vbulletin;		$mostvisiteds = $vbulletin->db->query_read("		SELECT * FROM " . TABLE_PREFIX . "fdwforum		WHERE userid = $userid AND relevance > 0		ORDER BY relevance DESC		LIMIT 0, {$vbulletin->options['fdw_forumhome_mostlimit']}	");		$most = $relevance = array();	while ($forum = $vbulletin->db->fetch_array($mostvisiteds))	{		$relevance["$forum[forumid]"] = $forum['relevance'];		$most["$forum[forumid]"] = $forum;	}	if (count($most) >= $vbulletin->options['fdw_forumhome_mostmin'])	{		$levelmax = explode(',', $vbulletin->options['fdw_forumhome_levelmax']);		if (count($levelmax))		{			$levels = fdw_fetch_levels($relevance, $levelmax);		}		else		{			$levels = fetch_standard_deviated_levels($relevance, $vbulletin->options['fdw_forumhome_levels']);		}				foreach ($levels AS $forumid => $level)		{			$most["$forumid"]['level'] = $level;		}	}	else	{		$most = array();	}		$ordered = $vbulletin->db->query_read("		SELECT fdwforum.forumid, small, fdwforum.displayorder, 1 AS fdwcolorid FROM " . TABLE_PREFIX . "fdwforum AS fdwforum		LEFT JOIN " . TABLE_PREFIX . "forum AS forum USING (forumid)		WHERE userid = $userid AND forum.parentid = -1 AND fdwforum.displayorder > 0		ORDER BY fdwforum.displayorder, forum.displayorder	");		$forums = array();	while ($forum = $vbulletin->db->fetch_array($ordered))	{		$forums["$forum[forumid]"] = array('fdwforum' => $forum);	}		$forumdata = $vbulletin->db->escape_string(serialize(array('most' => $most, 'ordered' => $forums)));		$vbulletin->db->query_write("		REPLACE INTO " . TABLE_PREFIX . "fdwsession (sessionhash, userid, fdwforum)			VALUES ('" . $vbulletin->db->escape_string($sessionhash) . "', $userid, '$forumdata');	");		return array('most' => $most, 'ordered' => $forums);}function fdw_fetch_levels($items, $levelmax){	global $vbulletin;		$retval = array();	$currentlevel = array(		'level' => $vbulletin->options['fdw_forumhome_levels'],		'counter' => 0,		'max' => array_shift($levelmax)	);	foreach ($items AS $key => $relevance)	{		$retval["$key"] = $currentlevel['level'];		$currentlevel['counter']++;		if ($currentlevel['max'] > 0 AND $currentlevel['counter'] == $currentlevel['max'])		{			$currentlevel['level']--;			$currentlevel['counter'] = 0;			if (count($levelmax) > 0)			{				$currentlevel['max'] = array_shift($levelmax);			}			else			{				$currentlevel['max'] = 0;			}		}	}	return $retval;}function fdw_fetch_relevant_threads($forumid, $conditions = array()){	global $vbulletin;		$relevancesum = array(0);	if ($vbulletin->options['fdw_forumcustom_relevancedate'])	{		$relevancecut = TIMENOW - ($vbulletin->options['fdw_forumcustom_relevancedate'] * 24 * 60 * 60);	}	if ($vbulletin->options['fdw_forumcustom_relevanceposts'])	{		if ($vbulletin->options['fdw_forumcustom_relevancedate'])		{			$coventry = fetch_coventry('string', true);			$relevancesum[] = "				(					IFNULL((						SELECT COUNT(*)						FROM " . TABLE_PREFIX . "post AS post						WHERE post.threadid = thread.threadid							" . ($coventry ? "AND post.userid NOT IN ($coventry)" : '') . "							AND post.dateline > $relevancecut					), 0) * {$vbulletin->options['fdw_forumcustom_relevanceposts']}				)			";		}		else		{			$relevancesum[] = "(CAST(replycount AS SIGNED) * {$vbulletin->options['fdw_forumcustom_relevanceposts']})";		}	}	if ($vbulletin->options['fdw_forumcustom_relevancerate'])	{		$relevancesum[] = "((votetotal / votenum) * {$vbulletin->options['fdw_forumcustom_relevancerate']})";	}	if ($vbulletin->options['fdw_forumcustom_relevanceviews'])	{		$relevancesum[] = "(CAST(views) AS SIGNED * {$vbulletin->options['fdw_forumcustom_relevanceviews']})";	}	if ($vbulletin->options['fdw_forumcustom_vote'] AND $vbulletin->options['fdw_forumcustom_relevancevote'])	{		if ($vbulletin->options['fdw_forumcustom_relevancedate'])		{			$relevancesum[] = "				(					IFNULL((						SELECT SUM(IF(vote = 2, 1, 0)) - SUM(IF(vote = 1, 1, 0))						FROM " . TABLE_PREFIX . "fdwvote AS fdwvote						WHERE fdwvote.threadid = thread.threadid AND votedate > $relevancecut					), 0) * {$vbulletin->options['fdw_forumcustom_relevancevote']}				)			";		}		else		{			$relevancesum[] = "((votepos - voteneg) * {$vbulletin->options['fdw_forumcustom_relevancevote']})";		}	}	$datecut = TIMENOW - ($vbulletin->options['fdw_forumcustom_datecut'] * 24 * 60 * 60);		$threads = $vbulletin->db->query_read("		SELECT thread.threadid, (" . implode(' + ', $relevancesum) . ") AS relevance		FROM " . TABLE_PREFIX . "thread AS thread		WHERE forumid = $forumid AND thread.visible = 1 AND open <> 10 AND lastpost > $datecut		ORDER BY relevance DESC		LIMIT {$vbulletin->options['fdw_forumcustom_maxpp']}	");		$threadids = array();	while ($thread = $vbulletin->db->fetch_array($threads))	{		$threadids[] = $thread['threadid'];	}	$threadids = implode(',', $threadids);		$vbulletin->db->query_write("		REPLACE INTO " . TABLE_PREFIX . "fdwthread (forumid, threadids, forumcache) VALUES ($forumid, '$threadids', " . TIMENOW . ")	");		return $threadids;}