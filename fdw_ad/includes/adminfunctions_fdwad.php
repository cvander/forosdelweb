<?php/*======================================================================*\|| #################################################################### |||| # Ad Manager - Foros del Web                                       # |||| # @author      David Barrios <davidbarriosfdw@gmail.com            # |||| #################################################################### ||\*======================================================================*/require_once(DIR . '/includes/adminfunctions_template.php');function cache_ads(){	global $db;		$ad_cache = array();	$ad_result = $db->query_read("SELECT * FROM " . TABLE_PREFIX . "fdwad ORDER BY display");	while ($ad = $db->fetch_array($ad_result))	{		$ad_cache["$ad[adid]"] = $ad;	}	$db->free_result($ad_result);		return $ad_cache;}function criteria_types(){	global $db;		$criterias = array();	$criteriatypes = $db->query_read("SELECT * FROM " . TABLE_PREFIX . "fdwadcriteriatype");	while ($criteria = $db->fetch_array($criteriatypes))	{		$criterias[$criteria['name']] = $criteria;	}		return $criterias;}function criteria_validate($criteria, $values){	global $vbulletin, $db;	if ($criteria['validation'])	{		return eval($criteria['validation']);	}	else	{		return true;	}}function criteria_values($adid){	global $db;		$criteriavalues = array();	$adcriterias = $db->query_read("		SELECT name, value FROM " . TABLE_PREFIX . "fdwadcriteria AS fdwadcriteria		LEFT JOIN " . TABLE_PREFIX . "fdwadcriteriatype AS fdwadcriteriatype			ON (fdwadcriteria.typeid = fdwadcriteriatype.typeid)		WHERE adid = $adid	");	while ($adcriteria = $db->fetch_array($adcriterias))	{		$criteriavalues[$adcriteria['name']] = unserialize($adcriteria['value']);	}	return $criteriavalues;}function print_criteria($criteria, $value = null){	global $vbulletin, $vbphrase, $db, $ad_cache;		if ($criteria['display'])	{		$result = eval($criteria['display']);		if (!$result)		{			return;		}	}		if ($value === null AND $criteria['defaultvalue'])	{		$defaultvalue = eval($criteria['defaultvalue']);	}	else	{		$defaultvalue = $value;	}		$formatted = array();	$elements = eval($criteria['optioncode']);	foreach ($elements AS $element)	{		$formatted[] = "</label>$element<label for=\"cb_$criteria[name]\">";	}	$elements = array_merge(array($vbphrase["$criteria[name]_criteria"]), $formatted);	$text = '<label for="cb_' . $criteria['name'] . '">' . call_user_func_array('construct_phrase', $elements) . '</label>';		$checked = ($value !== null) ? ' checked="checked"' : '';	print_description_row(		"<input type=\"checkbox\" id=\"cb_$criteria[name]\" name=\"activecriteria[$criteria[name]]\" title=\"$vbphrase[criterion_is_active]\" value=\"1\"$checked />" .		"<span id=\"span_$criteria[name]\">$text</span>"	);}function rebuild_ad_templates(){	global $vbulletin, $db, $criteriatypes, $ad_cache;		$ad_templates = array(		'forumdisplay_ad_left' => '',		'forumdisplay_ad_right' => ''	);		foreach($ad_cache AS $adid => $ad)	{		if (!$ad['active'])		{			continue;		}				$criteriavalues = criteria_values($adid);				$prefix = $postfix = $adtemplate = '';				if (count($criteriavalues) > 0)		{			foreach($criteriavalues AS $criterianame => $values)			{				if ($criteriatypes[$criterianame]['templatecode'])				{					$conditions = eval($criteriatypes[$criterianame]['templatecode']);					foreach ($conditions AS $condition)					{						$prefix .= '<if condition="' . $condition . '">';						$postfix .= '</if>';					}				}			}		}				$prefix .= '<if condition="$fdwad_displayed[] = ' . $adid . '"></if>';				$adtemplate = $ad['code'];		if ($ad['wrapper'])		{			$template = $db->query_first("				SELECT template FROM " . TABLE_PREFIX . "template				WHERE title = 'forumdisplay_ad_wrapper' AND styleid = -1 AND product = 'fdw_ad'			");			$vbulletin->templatecache['forumdisplay_ad_wrapper'] = $template['template'];			eval('$adtemplate = "' . fetch_template('forumdisplay_ad_wrapper') . '";');		}				$ad_templates["forumdisplay_ad_$ad[location]"] .= $prefix . $adtemplate . $postfix;	}		save_ad_template($ad_templates['forumdisplay_ad_left'], 'left');	save_ad_template($ad_templates['forumdisplay_ad_right'], 'right');}function save_ad_template($templatecode, $location){	global $vbulletin, $db;		$template = $db->query_first("		SELECT templateid FROM " . TABLE_PREFIX . "template		WHERE title = 'forumdisplay_ad_$location' AND styleid = -1 AND product = 'fdw_ad'	");		if (!$template)	{		print_stop_message('fdwad_cannot_save', "forumdisplay_ad_$location");	}		$parsed = compile_template($templatecode);		$db->query_write("		UPDATE " . TABLE_PREFIX . "template SET			template = '" . $db->escape_string($parsed) . "',			template_un = '" . $db->escape_string($templatecode) . "',			dateline = " . TIMENOW . ",			username = '" . $db->escape_string($vbulletin->userinfo['username']) . "'		WHERE templateid = $template[templateid]	");}